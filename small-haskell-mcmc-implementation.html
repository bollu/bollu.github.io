<!DOCTYPE html><meta charset='UTF-8'><html><head><link rel='alternate' type='application/rss+xml' href='feed.rss' title='A universe of sorts'/><link rel='stylesheet' href='katex/katex.min.css'    integrity='sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X'    crossorigin='anonymous'><!-- The loading of KaTeX is deferred to speed up page rendering --><link rel='stylesheet' href='prism/prism.css'><title> A Universe of Sorts </title><style>@font-face {font-family: 'Blog Mono'; src: url('/static/iosevka-fixed-extended.ttf');}@font-face {font-family: 'Blog Sans'; src: url('/static/Exo2-Regular.ttf');}@font-face {font-family: 'Blog Serif'; src: url('/static/Revans-Regular.ttf');}html { font-size: 100%; }html,body { text-size-adjust: none; -webkit-text-size-adjust: none; -moz-text-size-adjust: none; -ms-text-size-adjust: none; } body { background: linear-gradient(to right, #1565C0 50%, #C2185B 50%); color: #000000;  font-family: 'Blog Serif', sans-serif;  font-size: 18px; line-height: 1.4em;  margin-top: 0px;  max-width: 100%; overflow-x: hidden; }
h1, h2, h3, h4, h5 { font-family: 'Blog Sans' }img { display:block; width: 100%; max-width: 800px; height: auto }.container { overflow-x: auto; overflow-y: hidden;  max-width: 80ex; text-align: justify;              margin-top: 0px; height: 100%; min-height: 100%;             padding-left: 50px; padding-right: 50px; background: #FFFFFF;}@media (max-width: 480px) {   .container { margin-left: 1%; margin-right: 1%; }  body { font-size: 30px; }  } @media (max-width: 1024px) {  .container { margin-left: 1%; margin-right: 1%; }  body { font-size: 30px; }}@media (min-width: 1024px) { .container { margin-left: 25%; margin-right: 20%; } }.image { }
a:hover { color: #1a73e8; text-decoration: underline;  }
a { color: #1a73e8; text-decoration: none; }
a:visited { color: #1a73e8; text-decoration: none; }
a:active { color: #1a73e8; text-decoration: none; }

blockquote { margin-left: 0px; margin-right: 0px; } pre, .latexblock, blockquote { border-left-color:#BBB;  border-left-style: solid;      border-left-width: 5px; }pre, blockquote { padding-left: 10px; }
pre { font-family: 'Blog Mono', monospace; font-size: 90%;  }pre {  overflow-x: auto; }.latexblock, blockquote, pre { margin-top: 10px; margin-bottom: 10px; padding-bottom: 5px; padding-top: 5px; background-color: #FFFFFF; }.latexblock { line-height: 1em }
pre, kbd, samp, tt{ font-family:'Blog Mono',monospace; }.inline { white-space: nowrap; background:#efefef; }ul, ol { list-style-position: inside; padding-left: 0; }ul { list-style-type: disclosure-closed; }</style></head><body><div class='container'><h2><a id=small-haskell-mcmc-implementation href='#small-haskell-mcmc-implementation'> § </a><span class='centered'> Small Haskell MCMC implementation </h2> 
 <span class='centered'>We create a simple monad called  <code class='inline'>PL</code> which allows for a single operation: sampling 
 <span class='centered'>from a uniform distribution. We then exploit this to implement MCMC using metropolis hastings, 
 <span class='centered'>which is used to sample from arbitrary distributions. Bonus is a small library to render sparklines 
 <span class='centered'>in the CLI.  
 <span class='centered'>For next time:  
 <ul><li><span class='centered'><span class='centered'> Using applicative to speed up computations by exploiting parallelism </li><li><span class='centered'><span class='centered'> Conditioning of a distribution wrt a variable </li></ul> 
 <h4><a id=source-code href='#source-code'> § </a><span class='centered'> Source code </h4>
 <pre><code><span class="token comment">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>
<span class="token comment">{-# LANGUAGE GADTs #-}</span>
<span class="token comment">{-# LANGUAGE StandaloneDeriving #-}</span>
<span class="token comment">{-# LANGUAGE FlexibleContexts #-}</span>
<span class="token comment">{-# LANGUAGE FlexibleInstances #-}</span>
<span class="token comment">{-# LANGUAGE UndecidableInstances #-}</span>
<span class="token comment">{-# LANGUAGE DeriveFunctor #-}</span>
<span class="token import-statement"><span class="token keyword">import</span> System.Random</span>
<span class="token import-statement"><span class="token keyword">import</span> Data.List</span><span class="token punctuation">(</span><span class="token builtin">sort</span><span class="token punctuation">,</span> <span class="token hvariable">nub</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Data.Proxy</span>
<span class="token import-statement"><span class="token keyword">import</span> Control.Monad</span> <span class="token punctuation">(</span><span class="token hvariable">replicateM</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> <span class="token keyword">qualified</span> Data.Map <span class="token keyword">as</span> M</span>


<span class="token comment">-- | Loop a monadic computation.</span>
<span class="token hvariable">mLoop</span> <span class="token operator">::</span> <span class="token constant">Monad</span> <span class="token hvariable">m</span> <span class="token operator">=></span>
      <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">m</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token comment">-- ^ loop</span>
      <span class="token operator">-></span> <span class="token constant">Int</span> <span class="token comment">-- ^ number of times to run</span>
      <span class="token operator">-></span> <span class="token hvariable">a</span> <span class="token comment">-- initial value</span>
      <span class="token operator">-></span> <span class="token hvariable">m</span> <span class="token hvariable">a</span> <span class="token comment">-- final value</span>
<span class="token hvariable">mLoop</span> <span class="token hvariable">_</span> <span class="token number">0</span> <span class="token hvariable">a</span> <span class="token operator">=</span> <span class="token builtin">return</span> <span class="token hvariable">a</span>
<span class="token hvariable">mLoop</span> <span class="token hvariable">f</span> <span class="token hvariable">n</span> <span class="token hvariable">a</span> <span class="token operator">=</span> <span class="token hvariable">f</span> <span class="token hvariable">a</span> <span class="token operator">>>=</span> <span class="token hvariable">mLoop</span> <span class="token hvariable">f</span> <span class="token punctuation">(</span><span class="token hvariable">n</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>


<span class="token comment">-- | Utility library for drawing sparklines</span>

<span class="token comment">-- | List of characters that represent sparklines</span>
<span class="token hvariable">sparkchars</span> <span class="token operator">::</span> <span class="token constant">String</span>
<span class="token hvariable">sparkchars</span> <span class="token operator">=</span> <span class="token string">"_▁▂▃▄▅▆▇█"</span>

<span class="token comment">-- Convert an int to a sparkline character</span>
<span class="token hvariable">num2spark</span> <span class="token operator">::</span> <span class="token constant">RealFrac</span> <span class="token hvariable">a</span> <span class="token operator">=></span> <span class="token hvariable">a</span> <span class="token comment">-- ^ Max value</span>
  <span class="token operator">-></span> <span class="token hvariable">a</span> <span class="token comment">-- ^ Current value</span>
  <span class="token operator">-></span> <span class="token constant">Char</span>
<span class="token hvariable">num2spark</span> <span class="token hvariable">maxv</span> <span class="token hvariable">curv</span> <span class="token operator">=</span>
   <span class="token hvariable">sparkchars</span> <span class="token operator">!!</span>
     <span class="token punctuation">(</span><span class="token builtin">floor</span> <span class="token operator">$</span> <span class="token punctuation">(</span><span class="token hvariable">curv</span> <span class="token operator">/</span> <span class="token hvariable">maxv</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token builtin">fromIntegral</span> <span class="token punctuation">(</span><span class="token builtin">length</span> <span class="token hvariable">sparkchars</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token hvariable">series2spark</span> <span class="token operator">::</span> <span class="token constant">RealFrac</span> <span class="token hvariable">a</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span> <span class="token operator">-></span> <span class="token constant">String</span>
<span class="token hvariable">series2spark</span> <span class="token hvariable">vs</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token hvariable">maxv</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token builtin">null</span> <span class="token hvariable">vs</span> <span class="token keyword">then</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token builtin">maximum</span> <span class="token hvariable">vs</span>
  <span class="token keyword">in</span> <span class="token builtin">map</span> <span class="token punctuation">(</span><span class="token hvariable">num2spark</span> <span class="token hvariable">maxv</span><span class="token punctuation">)</span> <span class="token hvariable">vs</span>

<span class="token hvariable">seriesPrintSpark</span> <span class="token operator">::</span> <span class="token constant">RealFrac</span> <span class="token hvariable">a</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span> <span class="token operator">-></span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">seriesPrintSpark</span> <span class="token operator">=</span> <span class="token builtin">putStrLn</span><span class="token operator"> . </span><span class="token hvariable">series2spark</span>

<span class="token comment">-- Probabilities</span>
<span class="token comment">-- ============</span>
<span class="token keyword">type</span> <span class="token constant">F</span> <span class="token operator">=</span> <span class="token constant">Float</span>
<span class="token comment">-- | probability density</span>
<span class="token keyword">newtype</span> <span class="token constant">P</span> <span class="token operator">=</span> <span class="token constant">P</span> <span class="token punctuation">{</span> <span class="token hvariable">unP</span> <span class="token operator">::</span> <span class="token constant">Float</span> <span class="token punctuation">}</span> <span class="token keyword">deriving</span><span class="token punctuation">(</span><span class="token constant">Num</span><span class="token punctuation">)</span>

<span class="token comment">-- | prob. distributions over space a</span>
<span class="token keyword">newtype</span> <span class="token constant">D</span> <span class="token hvariable">a</span> <span class="token operator">=</span> <span class="token constant">D</span> <span class="token punctuation">{</span> <span class="token hvariable">runD</span> <span class="token operator">::</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">P</span> <span class="token punctuation">}</span>

<span class="token hvariable">uniform</span> <span class="token operator">::</span> <span class="token constant">Int</span> <span class="token operator">-></span> <span class="token constant">D</span> <span class="token hvariable">a</span>
<span class="token hvariable">uniform</span> <span class="token hvariable">n</span> <span class="token operator">=</span>
  <span class="token constant">D</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">_</span> <span class="token operator">-></span> <span class="token constant">P</span> <span class="token operator">$</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token builtin">fromIntegral</span> <span class="token operator">$</span> <span class="token hvariable">n</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token operator">>$&lt;</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token constant">Contravariant</span> <span class="token hvariable">f</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">f</span> <span class="token hvariable">a</span>  <span class="token operator">-></span> <span class="token hvariable">f</span> <span class="token hvariable">b</span>
<span class="token punctuation">(</span><span class="token operator">>$&lt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">cofmap</span>

<span class="token keyword">instance</span> <span class="token constant">Contravariant</span> <span class="token constant">D</span> <span class="token keyword">where</span>
  <span class="token hvariable">cofmap</span> <span class="token hvariable">f</span> <span class="token punctuation">(</span><span class="token constant">D</span> <span class="token hvariable">d</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token constant">D</span> <span class="token punctuation">(</span><span class="token hvariable">d</span><span class="token operator"> . </span><span class="token hvariable">f</span><span class="token punctuation">)</span>

<span class="token comment">-- | Normal distribution with given mean</span>
<span class="token hvariable">normalD</span> <span class="token operator">::</span> <span class="token constant">Float</span> <span class="token operator">-></span>  <span class="token constant">D</span> <span class="token constant">Float</span>
<span class="token hvariable">normalD</span> <span class="token hvariable">mu</span> <span class="token operator">=</span> <span class="token constant">D</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">f</span> <span class="token operator">-></span> <span class="token constant">P</span> <span class="token operator">$</span> <span class="token builtin">exp</span> <span class="token punctuation">(</span><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token hvariable">f</span><span class="token operator">-</span><span class="token hvariable">mu</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">-- | Distribution that takes on value x^p for 1 &lt;= x &lt;= 2.  Is normalized</span>
<span class="token hvariable">polyD</span> <span class="token operator">::</span> <span class="token constant">Float</span> <span class="token operator">-></span> <span class="token constant">D</span> <span class="token constant">Float</span>
<span class="token hvariable">polyD</span> <span class="token hvariable">p</span> <span class="token operator">=</span> <span class="token constant">D</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">f</span> <span class="token operator">-></span> <span class="token constant">P</span> <span class="token operator">$</span> <span class="token keyword">if</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> <span class="token hvariable">f</span> <span class="token operator">&amp;&amp;</span> <span class="token hvariable">f</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token punctuation">(</span><span class="token hvariable">f</span> <span class="token operator">**</span> <span class="token hvariable">p</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token hvariable">p</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token punctuation">(</span><span class="token hvariable">p</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token number">0</span>

<span class="token keyword">class</span> <span class="token constant">Contravariant</span> <span class="token hvariable">f</span> <span class="token keyword">where</span>
  <span class="token hvariable">cofmap</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token hvariable">b</span> <span class="token operator">-></span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token hvariable">f</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">f</span> <span class="token hvariable">b</span>

<span class="token keyword">data</span> <span class="token constant">PL</span> <span class="token hvariable">next</span> <span class="token keyword">where</span>
    <span class="token constant">Ret</span> <span class="token operator">::</span> <span class="token hvariable">next</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">next</span> <span class="token comment">-- ^ return  a value</span>
    <span class="token constant">Sample01</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">Float</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">next</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">next</span> <span class="token comment">-- ^ sample uniformly from a [0, 1) distribution</span>

<span class="token keyword">instance</span> <span class="token constant">Monad</span> <span class="token constant">PL</span> <span class="token keyword">where</span>
  <span class="token builtin">return</span> <span class="token operator">=</span> <span class="token constant">Ret</span>
  <span class="token punctuation">(</span><span class="token constant">Ret</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">>>=</span> <span class="token hvariable">f</span> <span class="token operator">=</span> <span class="token hvariable">f</span> <span class="token hvariable">a</span>
  <span class="token punctuation">(</span><span class="token constant">Sample01</span> <span class="token hvariable">float2plnext</span><span class="token punctuation">)</span> <span class="token operator">>>=</span> <span class="token hvariable">next2next</span>' <span class="token operator">=</span>
      <span class="token constant">Sample01</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">f</span> <span class="token operator">-></span> <span class="token hvariable">float2plnext</span> <span class="token hvariable">f</span> <span class="token operator">>>=</span> <span class="token hvariable">next2next</span>'

<span class="token keyword">instance</span> <span class="token constant">Applicative</span> <span class="token constant">PL</span> <span class="token keyword">where</span>
    <span class="token hvariable">pure</span> <span class="token operator">=</span> <span class="token builtin">return</span>
    <span class="token hvariable">ff</span> <span class="token operator">&lt;*></span> <span class="token hvariable">fx</span> <span class="token operator">=</span> <span class="token keyword">do</span>
        <span class="token hvariable">f</span> <span class="token operator">&lt;-</span> <span class="token hvariable">ff</span>
        <span class="token hvariable">x</span> <span class="token operator">&lt;-</span> <span class="token hvariable">fx</span>
        <span class="token builtin">return</span> <span class="token operator">$</span> <span class="token hvariable">f</span> <span class="token hvariable">x</span>

<span class="token keyword">instance</span> <span class="token constant">Functor</span> <span class="token constant">PL</span> <span class="token keyword">where</span>
    <span class="token builtin">fmap</span> <span class="token hvariable">f</span> <span class="token hvariable">plx</span> <span class="token operator">=</span> <span class="token keyword">do</span>
         <span class="token hvariable">x</span> <span class="token operator">&lt;-</span> <span class="token hvariable">plx</span>
         <span class="token builtin">return</span> <span class="token operator">$</span> <span class="token hvariable">f</span> <span class="token hvariable">x</span>

<span class="token comment">-- | operation to sample from [0, 1)</span>
<span class="token hvariable">sample01</span> <span class="token operator">::</span> <span class="token constant">PL</span> <span class="token constant">Float</span>
<span class="token hvariable">sample01</span> <span class="token operator">=</span> <span class="token constant">Sample01</span> <span class="token constant">Ret</span>


<span class="token comment">-- | Run one step of MH on a distribution to obtain a (correlated) sample</span>
<span class="token hvariable">mhStep</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">Float</span><span class="token punctuation">)</span> <span class="token comment">-- ^ function to score sample with, proportional to distribution</span>
  <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token comment">-- ^ Proposal program</span>
  <span class="token operator">-></span> <span class="token hvariable">a</span> <span class="token comment">-- current sample</span>
  <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">a</span>
<span class="token hvariable">mhStep</span> <span class="token hvariable">f</span> <span class="token hvariable">q</span> <span class="token hvariable">a</span> <span class="token operator">=</span> <span class="token keyword">do</span>
 	<span class="token hvariable">a</span>' <span class="token operator">&lt;-</span> <span class="token hvariable">q</span> <span class="token hvariable">a</span>
 	<span class="token keyword">let</span> <span class="token hvariable">alpha</span> <span class="token operator">=</span> <span class="token hvariable">f</span> <span class="token hvariable">a</span>' <span class="token operator">/</span> <span class="token hvariable">f</span> <span class="token hvariable">a</span> <span class="token comment">-- acceptance ratio</span>
 	<span class="token hvariable">u</span> <span class="token operator">&lt;-</span> <span class="token hvariable">sample01</span>
 	<span class="token builtin">return</span> <span class="token operator">$</span> <span class="token keyword">if</span> <span class="token hvariable">u</span> <span class="token operator">&lt;=</span> <span class="token hvariable">alpha</span> <span class="token keyword">then</span> <span class="token hvariable">a</span>' <span class="token keyword">else</span> <span class="token hvariable">a</span>

<span class="token comment">-- Typeclass that can provide me with data to run MCMC on it</span>
<span class="token keyword">class</span> <span class="token constant">MCMC</span> <span class="token hvariable">a</span> <span class="token keyword">where</span>
    <span class="token hvariable">arbitrary</span> <span class="token operator">::</span> <span class="token hvariable">a</span>
    <span class="token hvariable">uniform2val</span> <span class="token operator">::</span> <span class="token constant">Float</span> <span class="token operator">-></span> <span class="token hvariable">a</span>

<span class="token keyword">instance</span> <span class="token constant">MCMC</span> <span class="token constant">Float</span> <span class="token keyword">where</span>
	<span class="token hvariable">arbitrary</span> <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token comment">-- map [0, 1) -> (-infty, infty)</span>
	<span class="token hvariable">uniform2val</span> <span class="token hvariable">v</span> <span class="token operator">=</span> <span class="token builtin">tan</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token builtin">pi</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token builtin">pi</span> <span class="token operator">*</span> <span class="token hvariable">v</span><span class="token punctuation">)</span>


<span class="token comment">{-
-- | Any enumerable object has a way to get me the starting point for MCMC
instance (Bounded a, Enum a) => MCMC a where
     arbitrary = toEnum 0
     uniform2val v = let
        maxf = fromIntegral . fromEnum $ maxBound
        minf = fromIntegral . fromEnum $ minBound
        in toEnum $ floor $ minf + v * (maxf - minf)
-}</span>


<span class="token comment">-- | Run MH to sample from a distribution</span>
<span class="token hvariable">mh</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">Float</span><span class="token punctuation">)</span> <span class="token comment">-- ^ function to score sample with</span>
 <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token comment">-- ^ proposal program</span>
 <span class="token operator">-></span> <span class="token hvariable">a</span> <span class="token comment">-- ^ current sample</span>
 <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">a</span>
<span class="token hvariable">mh</span> <span class="token hvariable">f</span> <span class="token hvariable">q</span> <span class="token hvariable">a</span> <span class="token operator">=</span> <span class="token hvariable">mLoop</span> <span class="token punctuation">(</span><span class="token hvariable">mhStep</span> <span class="token hvariable">f</span> <span class="token hvariable">q</span><span class="token punctuation">)</span> <span class="token number">100</span>  <span class="token operator">$</span> <span class="token hvariable">a</span>

<span class="token comment">-- | Construct a program to sample from an arbitrary distribution using MCMC</span>
<span class="token hvariable">mhD</span> <span class="token operator">::</span> <span class="token constant">MCMC</span> <span class="token hvariable">a</span> <span class="token operator">=></span> <span class="token constant">D</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">a</span>
<span class="token hvariable">mhD</span> <span class="token punctuation">(</span><span class="token constant">D</span> <span class="token hvariable">d</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">let</span>
      <span class="token hvariable">scorer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token hvariable">unP</span><span class="token operator"> . </span><span class="token hvariable">d</span><span class="token punctuation">)</span>
      <span class="token hvariable">proposal</span> <span class="token hvariable">_</span> <span class="token operator">=</span> <span class="token keyword">do</span>
        <span class="token hvariable">f</span> <span class="token operator">&lt;-</span> <span class="token hvariable">sample01</span>
        <span class="token builtin">return</span> <span class="token operator">$</span> <span class="token hvariable">uniform2val</span> <span class="token hvariable">f</span>
    <span class="token keyword">in</span> <span class="token hvariable">mh</span> <span class="token hvariable">scorer</span> <span class="token hvariable">proposal</span> <span class="token hvariable">arbitrary</span>


<span class="token comment">-- | Run the probabilistic value to get a sample</span>
<span class="token hvariable">sample</span> <span class="token operator">::</span> <span class="token constant">RandomGen</span> <span class="token hvariable">g</span> <span class="token operator">=></span> <span class="token hvariable">g</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token hvariable">a</span><span class="token punctuation">,</span> <span class="token hvariable">g</span><span class="token punctuation">)</span>
<span class="token hvariable">sample</span> <span class="token hvariable">g</span> <span class="token punctuation">(</span><span class="token constant">Ret</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token hvariable">a</span><span class="token punctuation">,</span> <span class="token hvariable">g</span><span class="token punctuation">)</span>
<span class="token hvariable">sample</span> <span class="token hvariable">g</span> <span class="token punctuation">(</span><span class="token constant">Sample01</span> <span class="token hvariable">f2plnext</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token hvariable">f</span><span class="token punctuation">,</span> <span class="token hvariable">g</span>'<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">random</span> <span class="token hvariable">g</span> <span class="token keyword">in</span> <span class="token hvariable">sample</span> <span class="token hvariable">g</span>' <span class="token punctuation">(</span><span class="token hvariable">f2plnext</span> <span class="token hvariable">f</span><span class="token punctuation">)</span>


<span class="token comment">-- | Sample n values from the distribution</span>
<span class="token hvariable">samples</span> <span class="token operator">::</span> <span class="token constant">RandomGen</span> <span class="token hvariable">g</span> <span class="token operator">=></span> <span class="token constant">Int</span> <span class="token operator">-></span> <span class="token hvariable">g</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token hvariable">g</span><span class="token punctuation">)</span>
<span class="token hvariable">samples</span> <span class="token number">0</span> <span class="token hvariable">g</span> <span class="token hvariable">_</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token hvariable">g</span><span class="token punctuation">)</span>
<span class="token hvariable">samples</span> <span class="token hvariable">n</span> <span class="token hvariable">g</span> <span class="token hvariable">pl</span> <span class="token operator">=</span> <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token hvariable">a</span><span class="token punctuation">,</span> <span class="token hvariable">g</span>'<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">sample</span> <span class="token hvariable">g</span> <span class="token hvariable">pl</span>
                     <span class="token punctuation">(</span><span class="token hvariable">as</span><span class="token punctuation">,</span> <span class="token hvariable">g</span>''<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">samples</span> <span class="token punctuation">(</span><span class="token hvariable">n</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token hvariable">g</span>' <span class="token hvariable">pl</span>
                 <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token hvariable">a</span><span class="token operator">:</span><span class="token hvariable">as</span><span class="token punctuation">,</span> <span class="token hvariable">g</span>''<span class="token punctuation">)</span>

<span class="token comment">-- | count fraction of times value occurs in list</span>
<span class="token hvariable">occurFrac</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">Eq</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span> <span class="token operator">-></span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">Float</span>
<span class="token hvariable">occurFrac</span> <span class="token hvariable">as</span> <span class="token hvariable">a</span> <span class="token operator">=</span>
    <span class="token keyword">let</span> <span class="token hvariable">noccur</span> <span class="token operator">=</span> <span class="token builtin">length</span> <span class="token punctuation">(</span><span class="token builtin">filter</span> <span class="token punctuation">(</span><span class="token operator">==</span><span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token hvariable">as</span><span class="token punctuation">)</span>
        <span class="token hvariable">n</span> <span class="token operator">=</span> <span class="token builtin">length</span> <span class="token hvariable">as</span>
    <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token builtin">fromIntegral</span> <span class="token hvariable">noccur</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token builtin">fromIntegral</span> <span class="token hvariable">n</span><span class="token punctuation">)</span>

<span class="token comment">-- | Produce a distribution from a PL by using the sampler to sample N times</span>
<span class="token hvariable">distribution</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">Eq</span> <span class="token hvariable">a</span><span class="token punctuation">,</span> <span class="token constant">Num</span> <span class="token hvariable">a</span><span class="token punctuation">,</span> <span class="token constant">RandomGen</span> <span class="token hvariable">g</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">Int</span> <span class="token operator">-></span> <span class="token hvariable">g</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token constant">D</span> <span class="token hvariable">a</span><span class="token punctuation">,</span> <span class="token hvariable">g</span><span class="token punctuation">)</span>
<span class="token hvariable">distribution</span> <span class="token hvariable">n</span> <span class="token hvariable">g</span> <span class="token hvariable">pl</span> <span class="token operator">=</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token hvariable">as</span><span class="token punctuation">,</span> <span class="token hvariable">g</span>'<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">samples</span> <span class="token hvariable">n</span> <span class="token hvariable">g</span> <span class="token hvariable">pl</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token constant">D</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token constant">P</span> <span class="token punctuation">(</span><span class="token hvariable">occurFrac</span> <span class="token hvariable">as</span> <span class="token hvariable">a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token hvariable">g</span>'<span class="token punctuation">)</span>


<span class="token comment">-- | biased coin</span>
<span class="token hvariable">coin</span> <span class="token operator">::</span> <span class="token constant">Float</span> <span class="token operator">-></span> <span class="token constant">PL</span> <span class="token constant">Int</span> <span class="token comment">-- 1 with prob. p1, 0 with prob. (1 - p1)</span>
<span class="token hvariable">coin</span> <span class="token hvariable">p1</span> <span class="token operator">=</span> <span class="token keyword">do</span>
    <span class="token constant">Sample01</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">f</span> <span class="token operator">-></span> <span class="token constant">Ret</span> <span class="token operator">$</span> <span class="token keyword">if</span> <span class="token hvariable">f</span> <span class="token operator">&lt;</span> <span class="token hvariable">p1</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">)</span>


<span class="token comment">-- | Create a histogram from values.</span>
<span class="token hvariable">histogram</span> <span class="token operator">::</span> <span class="token constant">Int</span> <span class="token comment">-- ^ number of buckets</span>
          <span class="token operator">-></span> <span class="token punctuation">[</span><span class="token constant">Float</span><span class="token punctuation">]</span> <span class="token comment">-- values</span>
          <span class="token operator">-></span> <span class="token punctuation">[</span><span class="token constant">Int</span><span class="token punctuation">]</span>
<span class="token hvariable">histogram</span> <span class="token hvariable">nbuckets</span> <span class="token hvariable">as</span> <span class="token operator">=</span>
    <span class="token keyword">let</span>
        <span class="token hvariable">minv</span> <span class="token operator">::</span> <span class="token constant">Float</span>
        <span class="token hvariable">minv</span> <span class="token operator">=</span> <span class="token builtin">minimum</span> <span class="token hvariable">as</span>
        <span class="token hvariable">maxv</span> <span class="token operator">::</span> <span class="token constant">Float</span>
        <span class="token hvariable">maxv</span> <span class="token operator">=</span> <span class="token builtin">maximum</span> <span class="token hvariable">as</span>
        <span class="token comment">-- value per bucket</span>
        <span class="token hvariable">perbucket</span> <span class="token operator">::</span> <span class="token constant">Float</span>
        <span class="token hvariable">perbucket</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token hvariable">maxv</span> <span class="token operator">-</span> <span class="token hvariable">minv</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token builtin">fromIntegral</span> <span class="token hvariable">nbuckets</span><span class="token punctuation">)</span>
        <span class="token hvariable">bucket</span> <span class="token operator">::</span> <span class="token constant">Float</span> <span class="token operator">-></span> <span class="token constant">Int</span>
        <span class="token hvariable">bucket</span> <span class="token hvariable">v</span> <span class="token operator">=</span> <span class="token builtin">floor</span> <span class="token punctuation">(</span><span class="token hvariable">v</span> <span class="token operator">/</span> <span class="token hvariable">perbucket</span><span class="token punctuation">)</span>
        <span class="token hvariable">bucketed</span> <span class="token operator">::</span> <span class="token constant">M.Map</span> <span class="token constant">Int</span> <span class="token constant">Int</span>
        <span class="token hvariable">bucketed</span> <span class="token operator">=</span> <span class="token builtin">foldl</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">m</span> <span class="token hvariable">v</span> <span class="token operator">-></span> <span class="token hvariable">M.insertWith</span> <span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">bucket</span> <span class="token hvariable">v</span><span class="token punctuation">)</span> <span class="token number">1</span> <span class="token hvariable">m</span><span class="token punctuation">)</span> <span class="token hvariable">mempty</span> <span class="token hvariable">as</span>
     <span class="token keyword">in</span> <span class="token builtin">map</span> <span class="token builtin">snd</span><span class="token operator"> . </span><span class="token hvariable">M.toList</span> <span class="token operator">$</span> <span class="token hvariable">bucketed</span>


<span class="token hvariable">printSamples</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">Real</span> <span class="token hvariable">a</span><span class="token punctuation">,</span> <span class="token constant">Eq</span> <span class="token hvariable">a</span><span class="token punctuation">,</span> <span class="token constant">Ord</span> <span class="token hvariable">a</span><span class="token punctuation">,</span> <span class="token constant">Show</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">String</span> <span class="token operator">-></span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span> <span class="token operator">-></span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">printSamples</span> <span class="token hvariable">s</span> <span class="token hvariable">as</span> <span class="token operator">=</span>  <span class="token keyword">do</span>
    <span class="token builtin">putStrLn</span> <span class="token operator">$</span> <span class="token string">"***"</span> <span class="token operator">&lt;></span> <span class="token hvariable">s</span>
    <span class="token builtin">putStrLn</span> <span class="token operator">$</span> <span class="token string">"   samples: "</span> <span class="token operator">&lt;></span> <span class="token hvariable">series2spark</span> <span class="token punctuation">(</span><span class="token builtin">map</span> <span class="token builtin">toRational</span> <span class="token hvariable">as</span><span class="token punctuation">)</span>

<span class="token hvariable">printHistogram</span> <span class="token operator">::</span> <span class="token punctuation">[</span><span class="token constant">Float</span><span class="token punctuation">]</span> <span class="token operator">-></span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">printHistogram</span> <span class="token hvariable">samples</span> <span class="token operator">=</span> <span class="token builtin">putStrLn</span> <span class="token operator">$</span> <span class="token hvariable">series2spark</span> <span class="token punctuation">(</span><span class="token builtin">map</span> <span class="token builtin">fromIntegral</span><span class="token operator"> . </span><span class="token hvariable">histogram</span> <span class="token number">10</span> <span class="token operator">$</span>  <span class="token hvariable">samples</span><span class="token punctuation">)</span>


<span class="token comment">-- | Given a coin bias, take samples and print bias</span>
<span class="token hvariable">printCoin</span> <span class="token operator">::</span> <span class="token constant">Float</span> <span class="token operator">-></span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">printCoin</span> <span class="token hvariable">bias</span> <span class="token operator">=</span> <span class="token keyword">do</span>
    <span class="token keyword">let</span> <span class="token hvariable">g</span> <span class="token operator">=</span> <span class="token hvariable">mkStdGen</span> <span class="token number">1</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token hvariable">tosses</span><span class="token punctuation">,</span> <span class="token hvariable">_</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">samples</span> <span class="token number">100</span> <span class="token hvariable">g</span> <span class="token punctuation">(</span><span class="token hvariable">coin</span> <span class="token hvariable">bias</span><span class="token punctuation">)</span>
    <span class="token hvariable">printSamples</span> <span class="token punctuation">(</span><span class="token string">"bias: "</span> <span class="token operator">&lt;></span> <span class="token builtin">show</span> <span class="token hvariable">bias</span><span class="token punctuation">)</span> <span class="token hvariable">tosses</span>



<span class="token comment">-- | Create normal distribution as sum of uniform distributions.</span>
<span class="token hvariable">normal</span> <span class="token operator">::</span> <span class="token constant">PL</span> <span class="token constant">Float</span>
<span class="token hvariable">normal</span> <span class="token operator">=</span>  <span class="token builtin">fromIntegral</span><span class="token operator"> . </span><span class="token builtin">sum</span> <span class="token operator">&lt;$></span> <span class="token punctuation">(</span><span class="token hvariable">replicateM</span> <span class="token number">5</span> <span class="token punctuation">(</span><span class="token hvariable">coin</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token hvariable">main</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">main</span> <span class="token operator">=</span> <span class="token keyword">do</span>
    <span class="token hvariable">printCoin</span> <span class="token number">0.01</span>
    <span class="token hvariable">printCoin</span> <span class="token number">0.99</span>
    <span class="token hvariable">printCoin</span> <span class="token number">0.5</span>
    <span class="token hvariable">printCoin</span> <span class="token number">0.7</span>

    <span class="token builtin">putStrLn</span> <span class="token operator">$</span> <span class="token string">"normal distribution using central limit theorem: "</span>
    <span class="token keyword">let</span> <span class="token hvariable">g</span> <span class="token operator">=</span> <span class="token hvariable">mkStdGen</span> <span class="token number">1</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token hvariable">nsamples</span><span class="token punctuation">,</span> <span class="token hvariable">_</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">samples</span> <span class="token number">1000</span> <span class="token hvariable">g</span> <span class="token hvariable">normal</span>
    <span class="token comment">-- printSamples "normal: " nsamples</span>
    <span class="token hvariable">printHistogram</span> <span class="token hvariable">nsamples</span>


    <span class="token builtin">putStrLn</span> <span class="token operator">$</span> <span class="token string">"normal distribution using MCMC: "</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token hvariable">mcmcsamples</span><span class="token punctuation">,</span> <span class="token hvariable">_</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">samples</span> <span class="token number">1000</span> <span class="token hvariable">g</span> <span class="token punctuation">(</span><span class="token hvariable">mhD</span> <span class="token operator">$</span>  <span class="token hvariable">normalD</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token hvariable">printHistogram</span> <span class="token hvariable">mcmcsamples</span>

    <span class="token builtin">putStrLn</span> <span class="token operator">$</span> <span class="token string">"sampling from x^4 with finite support"</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token hvariable">mcmcsamples</span><span class="token punctuation">,</span> <span class="token hvariable">_</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">samples</span> <span class="token number">1000</span> <span class="token hvariable">g</span> <span class="token punctuation">(</span><span class="token hvariable">mhD</span> <span class="token operator">$</span>  <span class="token hvariable">polyD</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token hvariable">printHistogram</span> <span class="token hvariable">mcmcsamples</span>
</code></pre> 
 <h4><a id=output href='#output'> § </a><span class='centered'> Output </h4> 
 <pre><code>***bias: 1.0e-2
   samples: ________________________________________█_█________
***bias: 0.99
   samples: ███████████████████████████████████████████████████
***bias: 0.5
   samples: __█____█__███_███_█__█_█___█_█_██___████████__█_███
***bias: 0.7
   samples: __█__█_█__███_█████__███_█_█_█_██_█_████████__█████
normal distribution using central limit theorem:
_▄▇█▄_
normal distribution using MCMC:
__▁▄█▅▂▁___
sampling from x^4 with finite support
▁▁▃▃▃▄▅▆▇█_

</code></pre> 
 <script src="https://utteranc.es/client.js"        repo="bollu/bollu.github.io"        issue-term="pathname"        label="question"        theme="github-light"        crossorigin="anonymous"        async></script></container></body></html>